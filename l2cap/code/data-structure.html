

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>L2CAP Main Data Structures &mdash; 个人知识库 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="L2CAP API for Higher Layers" href="api.html" />
    <link rel="prev" title="Code Architecture Analysis" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> 个人知识库
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">L2CAP Learning Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../spec/index.html">L2CAP Specification Learning Notes</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Code Architecture Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../btm/index.html">Bluetooth Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sdp/index.html">SDP Learning Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hfp/index.html">HFP Learning Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../a2dp/index.html">A2DP Learning Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">个人知识库</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">L2CAP Learning Notes</a> &raquo;</li>
        
          <li><a href="index.html">Code Architecture Analysis</a> &raquo;</li>
        
      <li>L2CAP Main Data Structures</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/l2cap/code/data-structure.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="l2cap-main-data-structures">
<h1>L2CAP Main Data Structures<a class="headerlink" href="#l2cap-main-data-structures" title="Permalink to this headline">¶</a></h1>
<div class="section" id="l2cap-main-data-structure">
<h2>L2CAP Main Data Structure<a class="headerlink" href="#l2cap-main-data-structure" title="Permalink to this headline">¶</a></h2>
<img alt="../../_images/2018070601.png" src="../../_images/2018070601.png" />
</div>
<div class="section" id="tl2c-cb">
<h2>tL2C_CB<a class="headerlink" href="#tl2c-cb" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define the L2CAP control structure</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">l2cap_trace_level</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">controller_xmit_window</span><span class="p">;</span> <span class="cm">/* Total ACL window for all links */</span>

  <span class="kt">uint16_t</span> <span class="n">round_robin_quota</span><span class="p">;</span>   <span class="cm">/* Round-robin link quota */</span>
  <span class="kt">uint16_t</span> <span class="n">round_robin_unacked</span><span class="p">;</span> <span class="cm">/* Round-robin unacked */</span>
  <span class="kt">bool</span> <span class="n">check_round_robin</span><span class="p">;</span>       <span class="cm">/* Do a round robin check */</span>

  <span class="kt">bool</span> <span class="n">is_cong_cback_context</span><span class="p">;</span>

  <span class="n">tL2C_LCB</span> <span class="n">lcb_pool</span><span class="p">[</span><span class="n">MAX_L2CAP_LINKS</span><span class="p">];</span>    <span class="cm">/* Link Control Block pool */</span>
  <span class="n">tL2C_CCB</span> <span class="n">ccb_pool</span><span class="p">[</span><span class="n">MAX_L2CAP_CHANNELS</span><span class="p">];</span> <span class="cm">/* Channel Control Block pool */</span>
  <span class="n">tL2C_RCB</span> <span class="n">rcb_pool</span><span class="p">[</span><span class="n">MAX_L2CAP_CLIENTS</span><span class="p">];</span>  <span class="cm">/* Registration info pool */</span>

  <span class="n">tL2C_CCB</span><span class="o">*</span> <span class="n">p_free_ccb_first</span><span class="p">;</span> <span class="cm">/* Pointer to first free CCB */</span>
  <span class="n">tL2C_CCB</span><span class="o">*</span> <span class="n">p_free_ccb_last</span><span class="p">;</span>  <span class="cm">/* Pointer to last  free CCB */</span>

  <span class="kt">uint8_t</span>
      <span class="n">desire_role</span><span class="p">;</span> <span class="cm">/* desire to be master/slave when accepting a connection */</span>
  <span class="kt">bool</span> <span class="n">disallow_switch</span><span class="p">;</span>     <span class="cm">/* false, to allow switch at create conn */</span>
  <span class="kt">uint16_t</span> <span class="n">num_lm_acl_bufs</span><span class="p">;</span> <span class="cm">/* # of ACL buffers on controller */</span>
  <span class="kt">uint16_t</span> <span class="n">idle_timeout</span><span class="p">;</span>    <span class="cm">/* Idle timeout */</span>

  <span class="n">list_t</span><span class="o">*</span> <span class="n">rcv_pending_q</span><span class="p">;</span>       <span class="cm">/* Recv pending queue */</span>
  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">receive_hold_timer</span><span class="p">;</span> <span class="cm">/* Timer entry for rcv hold */</span>

  <span class="n">tL2C_LCB</span><span class="o">*</span> <span class="n">p_cur_hcit_lcb</span><span class="p">;</span>  <span class="cm">/* Current HCI Transport buffer */</span>
  <span class="kt">uint16_t</span> <span class="n">num_links_active</span><span class="p">;</span> <span class="cm">/* Number of links active */</span>

<span class="cp">#if (L2CAP_NON_FLUSHABLE_PB_INCLUDED == TRUE)</span>
  <span class="kt">uint16_t</span> <span class="n">non_flushable_pbf</span><span class="p">;</span> <span class="cm">/* L2CAP_PKT_START_NON_FLUSHABLE if controller</span>
<span class="cm">                                 supports */</span>
  <span class="cm">/* Otherwise, L2CAP_PKT_START */</span>
  <span class="kt">bool</span> <span class="n">is_flush_active</span><span class="p">;</span> <span class="cm">/* true if an HCI_Enhanced_Flush has been sent */</span>
<span class="cp">#endif</span>

<span class="cp">#if (L2CAP_CONFORMANCE_TESTING == TRUE)</span>
  <span class="kt">uint32_t</span> <span class="n">test_info_resp</span><span class="p">;</span> <span class="cm">/* Conformance testing needs a dynamic response */</span>
<span class="cp">#endif</span>

<span class="cp">#if (L2CAP_NUM_FIXED_CHNLS &gt; 0)</span>
  <span class="n">tL2CAP_FIXED_CHNL_REG</span>
      <span class="n">fixed_reg</span><span class="p">[</span><span class="n">L2CAP_NUM_FIXED_CHNLS</span><span class="p">];</span> <span class="cm">/* Reg info for fixed channels */</span>
<span class="cp">#endif</span>

  <span class="kt">uint16_t</span> <span class="n">num_ble_links_active</span><span class="p">;</span> <span class="cm">/* Number of LE links active */</span>
  <span class="kt">bool</span> <span class="n">is_ble_connecting</span><span class="p">;</span>
  <span class="n">RawAddress</span> <span class="n">ble_connecting_bda</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">controller_le_xmit_window</span><span class="p">;</span> <span class="cm">/* Total ACL window for all links */</span>
  <span class="n">tL2C_BLE_FIXED_CHNLS_MASK</span> <span class="n">l2c_ble_fixed_chnls_mask</span><span class="p">;</span>  <span class="c1">// LE fixed channels mask</span>
  <span class="kt">uint16_t</span> <span class="n">num_lm_ble_bufs</span><span class="p">;</span>         <span class="cm">/* # of ACL buffers on controller */</span>
  <span class="kt">uint16_t</span> <span class="n">ble_round_robin_quota</span><span class="p">;</span>   <span class="cm">/* Round-robin link quota */</span>
  <span class="kt">uint16_t</span> <span class="n">ble_round_robin_unacked</span><span class="p">;</span> <span class="cm">/* Round-robin unacked */</span>
  <span class="kt">bool</span> <span class="n">ble_check_round_robin</span><span class="p">;</span>       <span class="cm">/* Do a round robin check */</span>
  <span class="n">tL2C_RCB</span> <span class="n">ble_rcb_pool</span><span class="p">[</span><span class="n">BLE_MAX_L2CAP_CLIENTS</span><span class="p">];</span> <span class="cm">/* Registration info pool */</span>

  <span class="n">tL2CA_ECHO_DATA_CB</span><span class="o">*</span> <span class="n">p_echo_data_cb</span><span class="p">;</span> <span class="cm">/* Echo data callback */</span>

<span class="cp">#if (L2CAP_HIGH_PRI_CHAN_QUOTA_IS_CONFIGURABLE == TRUE)</span>
  <span class="kt">uint16_t</span> <span class="n">high_pri_min_xmit_quota</span><span class="p">;</span> <span class="cm">/* Minimum number of ACL credit for high</span>
<span class="cm">                                       priority link */</span>
<span class="cp">#endif </span><span class="cm">/* (L2CAP_HIGH_PRI_CHAN_QUOTA_IS_CONFIGURABLE == TRUE) */</span><span class="cp"></span>

  <span class="kt">uint16_t</span> <span class="n">dyn_psm</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tL2C_CB</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">l2cap_trace_level</span></code></p>
<p>log debug level.  use <cite>L2CA_SetTraceLevel</cite> to set it’s value,
in <cite>l2c_init1</cite>, the default value is set as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(L2CAP_INITIAL_TRACE_LEVEL)</span>
  <span class="n">l2cb</span><span class="p">.</span><span class="n">l2cap_trace_level</span> <span class="o">=</span> <span class="n">L2CAP_INITIAL_TRACE_LEVEL</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="n">l2cb</span><span class="p">.</span><span class="n">l2cap_trace_level</span> <span class="o">=</span> <span class="n">BT_TRACE_LEVEL_NONE</span><span class="p">;</span> <span class="cm">/* No traces */</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">controller_xmit_window</span></code></p>
<p>Total ACL window for all links. it’s the controller buffer size(window).
if its value is zero, it means the controller window is full, then host can’t send packest to the controller.</p>
<p>it’s value mean that how many packets doest the host can transmit to the controller.</p>
<p>this value is initialized when receiving “Controller Buffer Size” event.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/*******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Function         l2c_link_processs_num_bufs</span>
<span class="cm"> *</span>
<span class="cm"> * Description      This function is called when a &quot;controller buffer size&quot;</span>
<span class="cm"> *                  event is first received from the controller. It updates</span>
<span class="cm"> *                  the L2CAP values.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns          void</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>
 <span class="kt">void</span> <span class="nf">l2c_link_processs_num_bufs</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">num_lm_acl_bufs</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">l2cb</span><span class="p">.</span><span class="n">num_lm_acl_bufs</span> <span class="o">=</span> <span class="n">l2cb</span><span class="p">.</span><span class="n">controller_xmit_window</span> <span class="o">=</span> <span class="n">num_lm_acl_bufs</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>this value is updated when receiving <strong>Number of Completed Packets Event</strong>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">l2c_link_process_num_completed_pkts</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">l2cb</span><span class="p">.</span><span class="n">controller_xmit_window</span> <span class="o">+=</span> <span class="n">num_sent</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">round_robin_quota</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">round_robin_unacked</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">check_round_robin</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">round_robin_quota</span></code> is total usable controller buffer when each low priority link cannot have at least one buffer.</p>
<p><code class="docutils literal notranslate"><span class="pre">round_robin_uacked</span></code> is the total packets sent  out but  not acked by controller, this  value will  be updated in <code class="docutils literal notranslate"><span class="pre">l2c_link_process_num_completed_pkts</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">check_round_robin</span></code> is set true when we were doing round-robin for low priority links.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_cong_cback_context</span></code></p>
<p>control if we can sent the packets to the controller now.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">lcb_pool</span></code></p>
<p>Link Control Block pool, we can always iterate all the existing link through the following code snippets:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">p_lcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">l2cb</span><span class="p">.</span><span class="n">lcb_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MAX_L2CAP_LINKS</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">,</span> <span class="n">p_lcb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
     <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ccb_pool</span></code></p>
<p>Channel Control Block pool. this  array will hold all the channel control blocks. the maxize is 20.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Put all the channel control blocks on the free queue */</span>
 <span class="k">for</span> <span class="p">(</span><span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">MAX_L2CAP_CHANNELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">xx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">l2cb</span><span class="p">.</span><span class="n">ccb_pool</span><span class="p">[</span><span class="n">xx</span><span class="p">].</span><span class="n">p_next_ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">l2cb</span><span class="p">.</span><span class="n">ccb_pool</span><span class="p">[</span><span class="n">xx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
 <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">rcb_pool</span></code></p>
<p>Registration info pool. when an <code class="docutils literal notranslate"><span class="pre">L2CA_Register</span></code> called, it will allocate one element for it.
this arrays hold an element for every PSM currently registered to the L2CAP layer.</p>
<p>The maximum number of simultaneous applications(ER/EDR) that can register with L2CAP is MAX_L2CAP_CLIENTS(19)</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_free_ccb_first</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_free_ccb_last</span></code></p>
<p>this is the shortcut to find a free CCB,  it also maintain the list of free CCB.</p>
<p>see <code class="docutils literal notranslate"><span class="pre">l2cu_allocate_ccb</span></code> and <code class="docutils literal notranslate"><span class="pre">l2cu_release_ccb</span></code>.</p>
<p>at <code class="docutils literal notranslate"><span class="pre">l2c_init()</span></code>, it’s initialized as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">l2cb</span><span class="p">.</span><span class="n">p_free_ccb_first</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">l2cb</span><span class="p">.</span><span class="n">ccb_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">l2cb</span><span class="p">.</span><span class="n">p_free_ccb_last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">l2cb</span><span class="p">.</span><span class="n">ccb_pool</span><span class="p">[</span><span class="n">MAX_L2CAP_CHANNELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">desire_role</span></code></p>
<p>desire to be master/slave when accepting a connection. generally, the device who initialize a connection will be the master.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">disallow_switch</span></code></p>
<p>default to set to <code class="docutils literal notranslate"><span class="pre">false</span></code>. wether to allow switch at create conn.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">num_lm_acl_bufs</span></code></p>
<p>the number of the ACL buffers on controller. <code class="docutils literal notranslate"><span class="pre">controller_xmit_window</span></code> should never exceed this value.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idle_timeout</span></code></p>
<p>The number of seconds of link inactivity before a link is disconnected.initilized during <code class="docutils literal notranslate"><span class="pre">l2c_init()</span></code>, the default value is 4s.</p>
<p>use <code class="docutils literal notranslate"><span class="pre">L2CA_SetIdleTimeout()</span></code> to change the default value.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">rcv_pending_q</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">receive_hold_timer</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">rcv_pending_q</span></code> is a queue for holding any L2CAP packets that arrived before the HCI Complete Event arrived.</p>
<p><code class="docutils literal notranslate"><span class="pre">receive_holder_timer</span></code> is a timer for processing the packets in the above queue.</p>
<p>both vars are initialzed during <code class="docutils literal notranslate"><span class="pre">l2c_init()</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_cur_hcit_lcb</span></code></p>
<p>Current HCI Transport buffer.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">num_links_active</span></code></p>
<p>Number of links active. updated when <code class="docutils literal notranslate"><span class="pre">l2cu_allocate_lcb</span></code> and <code class="docutils literal notranslate"><span class="pre">l2cu_release_lcb</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">non_flushable_pbf</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_flush_active</span></code></p>
<p>these two vars are related to l2cap flush setting.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">fixed_reg</span></code></p>
<p>Reg info for fixed channels</p>
<p>using <code class="docutils literal notranslate"><span class="pre">L2CA_RegisterFixedChannel</span></code> and <code class="docutils literal notranslate"><span class="pre">L2CA_RemoveFixedChnl</span></code> to add and remove fixed channel registration.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">num_ble_links_active</span></code></p>
<p>Number of LE links active. updated when <code class="docutils literal notranslate"><span class="pre">l2cu_allocate_lcb</span></code> and <code class="docutils literal notranslate"><span class="pre">l2cu_release_lcb</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_ble_connecting</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_connecting_bda</span></code></p>
<p>state for ble connection progress and the remote device address we’re going to connect.</p>
<p>refer to <code class="docutils literal notranslate"><span class="pre">l2cble_init_direct_conn</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">controller_le_xmit_window</span></code></p>
<p>tramsmit window for LE links.</p>
<p>LE Fixed Channel Mask which shows what fixed channels support by the DUT.</p>
<p>during <code class="docutils literal notranslate"><span class="pre">l2c_init</span></code>, we have the following settings:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">l2cb</span><span class="p">.</span><span class="n">l2c_ble_fixed_chnls_mask</span> <span class="o">=</span> <span class="n">L2CAP_FIXED_CHNL_ATT_BIT</span> <span class="o">|</span>
             <span class="n">L2CAP_FIXED_CHNL_BLE_SIG_BIT</span> <span class="o">|</span>
             <span class="n">L2CAP_FIXED_CHNL_SMP_BIT</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">num_lm_ble_bufs</span></code></p>
<p>ACL buffers on controller for LE device.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_round_robin_quota</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_round_robin_unacked</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_check_round_robin</span></code></p>
<p>vars for ajusting ble link quota.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_rcb_pool</span></code></p>
<p>Registration info pool for connected ble application, The maximum number of simultaneous applications that can register with LE L2CAP
is <strong>BLE_MAX_L2CAP_CLIENTS(15)</strong>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_echo_data_cb</span></code></p>
<p>pointer to the callback for echo request.</p>
<p>Hihger layer application can send echo request to the peer device with specific data,
this callback will be called when peer send echo response to the DUT.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">high_pri_min_xmit_quota</span></code></p>
<p>if Number of ACL buffers to use high priority channel is configurable, this value can be adjusted dynmamically,
its initial value is <strong>L2CAP_HIGH_PRI_MIN_XMIT_QUOTA(5)</strong>.</p>
</li>
</ul>
</div>
<div class="section" id="tl2c-lcb">
<h2>tL2C_LCB<a class="headerlink" href="#tl2c-lcb" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define a link control block. There is one link control block between</span>
<span class="cm"> * this device and any other device (i.e. BD ADDR).</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">t_l2c_linkcb</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">in_use</span><span class="p">;</span> <span class="cm">/* true when in use, false when not */</span>
  <span class="n">tL2C_LINK_STATE</span> <span class="n">link_state</span><span class="p">;</span>

  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">l2c_lcb_timer</span><span class="p">;</span> <span class="cm">/* Timer entry for timeout evt */</span>
  <span class="kt">uint16_t</span> <span class="n">handle</span><span class="p">;</span>        <span class="cm">/* The handle used with LM */</span>

  <span class="n">tL2C_CCB_Q</span> <span class="n">ccb_queue</span><span class="p">;</span> <span class="cm">/* Queue of CCBs on this LCB */</span>

  <span class="n">tL2C_CCB</span><span class="o">*</span> <span class="n">p_pending_ccb</span><span class="p">;</span>  <span class="cm">/* ccb of waiting channel during link disconnect */</span>
  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">info_resp_timer</span><span class="p">;</span> <span class="cm">/* Timer entry for info resp timeout evt */</span>
  <span class="n">RawAddress</span> <span class="n">remote_bd_addr</span><span class="p">;</span> <span class="cm">/* The BD address of the remote */</span>

  <span class="kt">uint8_t</span> <span class="n">link_role</span><span class="p">;</span> <span class="cm">/* Master or slave */</span>
  <span class="kt">uint8_t</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">cur_echo_id</span><span class="p">;</span>              <span class="cm">/* Current id value for echo request */</span>
  <span class="n">tL2CA_ECHO_RSP_CB</span><span class="o">*</span> <span class="n">p_echo_rsp_cb</span><span class="p">;</span> <span class="cm">/* Echo response callback */</span>
  <span class="kt">uint16_t</span> <span class="n">idle_timeout</span><span class="p">;</span>            <span class="cm">/* Idle timeout */</span>
  <span class="kt">bool</span> <span class="n">is_bonding</span><span class="p">;</span>                  <span class="cm">/* True - link active only for bonding */</span>

  <span class="kt">uint16_t</span> <span class="n">link_flush_tout</span><span class="p">;</span> <span class="cm">/* Flush timeout used */</span>

  <span class="kt">uint16_t</span> <span class="n">link_xmit_quota</span><span class="p">;</span> <span class="cm">/* Num outstanding pkts allowed */</span>
  <span class="kt">uint16_t</span> <span class="n">sent_not_acked</span><span class="p">;</span>  <span class="cm">/* Num packets sent but not acked */</span>

  <span class="kt">bool</span> <span class="n">partial_segment_being_sent</span><span class="p">;</span> <span class="cm">/* Set true when a partial segment */</span>
                                   <span class="cm">/* is being sent. */</span>
  <span class="kt">bool</span> <span class="n">w4_info_rsp</span><span class="p">;</span>                <span class="cm">/* true when info request is active */</span>
  <span class="kt">uint8_t</span> <span class="n">info_rx_bits</span><span class="p">;</span>            <span class="cm">/* set 1 if received info type */</span>
  <span class="kt">uint32_t</span> <span class="n">peer_ext_fea</span><span class="p">;</span>           <span class="cm">/* Peer&#39;s extended features mask */</span>
  <span class="n">list_t</span><span class="o">*</span> <span class="n">link_xmit_data_q</span><span class="p">;</span>        <span class="cm">/* Link transmit data buffer queue */</span>

  <span class="kt">uint8_t</span> <span class="n">peer_chnl_mask</span><span class="p">[</span><span class="n">L2CAP_FIXED_CHNL_ARRAY_SIZE</span><span class="p">];</span>
<span class="cp">#if (L2CAP_UCD_INCLUDED == TRUE)</span>
  <span class="kt">uint16_t</span> <span class="n">ucd_mtu</span><span class="p">;</span> <span class="cm">/* peer MTU on UCD */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span>
      <span class="n">ucd_out_sec_pending_q</span><span class="p">;</span> <span class="cm">/* Security pending outgoing UCD packet */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span>
      <span class="n">ucd_in_sec_pending_q</span><span class="p">;</span> <span class="cm">/* Security pending incoming UCD packet */</span>
<span class="cp">#endif</span>

  <span class="n">BT_HDR</span><span class="o">*</span> <span class="n">p_hcit_rcv_acl</span><span class="p">;</span>   <span class="cm">/* Current HCIT ACL buf being rcvd */</span>
  <span class="kt">uint16_t</span> <span class="n">idle_timeout_sv</span><span class="p">;</span> <span class="cm">/* Save current Idle timeout */</span>
  <span class="kt">uint8_t</span> <span class="n">acl_priority</span><span class="p">;</span>     <span class="cm">/* L2C_PRIORITY_NORMAL or L2C_PRIORITY_HIGH */</span>
  <span class="n">tL2CA_NOCP_CB</span><span class="o">*</span> <span class="n">p_nocp_cb</span><span class="p">;</span> <span class="cm">/* Num Cmpl pkts callback */</span>

<span class="cp">#if (L2CAP_NUM_FIXED_CHNLS &gt; 0)</span>
  <span class="n">tL2C_CCB</span><span class="o">*</span> <span class="n">p_fixed_ccbs</span><span class="p">[</span><span class="n">L2CAP_NUM_FIXED_CHNLS</span><span class="p">];</span>
  <span class="kt">uint16_t</span> <span class="n">disc_reason</span><span class="p">;</span>
<span class="cp">#endif</span>

  <span class="n">tBT_TRANSPORT</span> <span class="n">transport</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">initiating_phys</span><span class="p">;</span>  <span class="c1">// LE PHY used for connection initiation</span>
  <span class="n">tBLE_ADDR_TYPE</span> <span class="n">ble_addr_type</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">tx_data_len</span><span class="p">;</span> <span class="cm">/* tx data length used in data length extension */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span> <span class="n">le_sec_pending_q</span><span class="p">;</span> <span class="cm">/* LE coc channels waiting for security check</span>
<span class="cm">                                      completion */</span>
  <span class="kt">uint8_t</span> <span class="n">sec_act</span><span class="p">;</span>
<span class="cp">#define L2C_BLE_CONN_UPDATE_DISABLE \</span>
<span class="cp">  0x1                              </span><span class="cm">/* disable update connection parameters */</span><span class="cp"></span>
<span class="cp">#define L2C_BLE_NEW_CONN_PARAM 0x2 </span><span class="cm">/* new connection parameter to be set */</span><span class="cp"></span>
<span class="cp">#define L2C_BLE_UPDATE_PENDING                  \</span>
<span class="cp">  0x4 </span><span class="cm">/* waiting for connection update finished \</span>
<span class="cm">         */</span><span class="cp"></span>
<span class="cp">#define L2C_BLE_NOT_DEFAULT_PARAM \</span>
<span class="cp">  0x8 </span><span class="cm">/* not using default connection parameters */</span><span class="cp"></span>
  <span class="kt">uint8_t</span> <span class="n">conn_update_mask</span><span class="p">;</span>

  <span class="kt">uint16_t</span> <span class="n">min_interval</span><span class="p">;</span> <span class="cm">/* parameters as requested by peripheral */</span>
  <span class="kt">uint16_t</span> <span class="n">max_interval</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">latency</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">timeout</span><span class="p">;</span>

<span class="cp">#if (L2CAP_ROUND_ROBIN_CHANNEL_SERVICE == TRUE)</span>
  <span class="cm">/* each priority group is limited burst transmission */</span>
  <span class="cm">/* round robin service for the same priority channels */</span>
  <span class="n">tL2C_RR_SERV</span> <span class="n">rr_serv</span><span class="p">[</span><span class="n">L2CAP_NUM_CHNL_PRIORITY</span><span class="p">];</span>
  <span class="kt">uint8_t</span> <span class="n">rr_pri</span><span class="p">;</span> <span class="cm">/* current serving priority group */</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="n">tL2C_LCB</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">in_use</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">link_state</span></code></p>
<p>the max number of the link is <strong>MAX_L2CAP_LINKS(7)</strong>, for every link, there is an array element(<strong>lcb_pool</strong>) for it.
if it’s allocated, <em>in_use</em> will be set to true.</p>
<p>the <em>link_state</em> can be the one of the following:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define the possible L2CAP link states</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">LST_DISCONNECTED</span><span class="p">,</span>
  <span class="n">LST_CONNECT_HOLDING</span><span class="p">,</span>
  <span class="n">LST_CONNECTING_WAIT_SWITCH</span><span class="p">,</span>
  <span class="n">LST_CONNECTING</span><span class="p">,</span>
  <span class="n">LST_CONNECTED</span><span class="p">,</span>
  <span class="n">LST_DISCONNECTING</span>
<span class="p">}</span> <span class="n">tL2C_LINK_STATE</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">l2c_lcb_timer</span></code></p>
<p>Timer entry for timeout evt for a link.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">handle</span></code></p>
<blockquote>
<div><p>used with LM. handle identify a l2cap link between local DUT with the remote device. handle value(0xedc) is specific for SoC debug loggin.</p>
<p>handle value is returned from controller.  when the HCI Connection Complete event is received from the controller,
it will return the handle value to the upper layer and save it to this var.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ccb_queue</span></code></p>
<p>Queue of CCBs on this LCB. often use the following code snippets to iterate CCB on it:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">p_ccb</span> <span class="o">=</span> <span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">ccb_queue</span><span class="p">.</span><span class="n">p_first_ccb</span><span class="p">;</span> <span class="n">p_ccb</span><span class="p">;</span> <span class="n">p_ccb</span> <span class="o">=</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_next_ccb</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_pending_ccb</span></code></p>
<p>ccb of waiting channel during link disconnect. after disconnection complete, we can restart the channel for CCB.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">info_resp_timer</span></code></p>
<p>Timer entry for info resp timeout evt.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">remote_bd_addr</span></code></p>
<p>The BD address of the remote in this link.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">link_role</span></code></p>
<p>the DUT’s role in this link.  Master or Slave.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">id</span></code></p>
<p>this is the identifier value for every l2cap request/response on signaling channel between local DUT and remote device.</p>
<p>this value should be the same for each request and response pair. this value should not be 0.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">cur_echo_id</span></code></p>
<p>Current id value for echo request.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_echo_rsp_cb</span></code></p>
<p>Echo response callback.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idle_timeout</span></code></p>
<p>timeout value for Idle timeout.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idle_timeout</span></code></p>
<p>use this <code class="docutils literal notranslate"><span class="pre">L2CA_SetIdleTimeout</span></code> to update this value.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_bonding</span></code></p>
<p>when this value is true, it means this link is only active for bonding.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">link_flush_tout</span></code></p>
<p>Flush timeout used. use <code class="docutils literal notranslate"><span class="pre">L2CA_SetFlushTimeout</span></code> to update it.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">link_xmit_quota</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">sent_not_acked</span></code></p>
<p>Num outstanding pkts allowed  and Num packets sent but not acked.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">partial_segment_being_sent</span></code></p>
<p>Set true when a partial segment is being sent.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">w4_info_rsp</span></code></p>
<p>true when info request is active.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">info_rx_bits</span></code></p>
<p>set to 1 for received info type.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_ext_fea</span></code></p>
<p>hold peer’s extended feature mask.</p>
<img alt="../../_images/2018071501.png" src="../../_images/2018071501.png" />
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_chnl_mask</span></code></p>
<p>peer supported fixed channel type.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ucd_mtu</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ucd_out_sec_pending_q</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ucd_in_sec_pending_q</span></code></p>
<p>Security pending outgoing/incoming UCD(Unicast Connectionless Data) packet.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_hcit_rcv_acl</span></code></p>
<p>Current HCIT ACL buf being rcvd.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">idle_timeout_sv</span></code></p>
<p>Save current Idle timeout.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">acl_priority</span></code></p>
<p><strong>L2C_PRIORITY_NORMAL</strong> or <strong>L2C_PRIORITY_HIGH</strong>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_nocp_cb</span></code></p>
<p>callback for Number of Completed Packets.</p>
<p>use <em>L2CA_RegForNoCPEvt</em> to register the callback.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_fixed_ccbs</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">disc_reason</span></code></p>
<p>the number of the fixed channels is <strong>L2CAP_NUM_FIXED_CHNLS(32)</strong>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">transport</span></code></p>
<p>transport type: LE or ED/EDR.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">initiating_phys</span></code></p>
<p>LE PHY used for connection initiation.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_addr_type</span></code></p>
<img alt="../../_images/2018071502.png" src="../../_images/2018071502.png" />
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tx_data_len</span></code></p>
<p>tx data length used in data length extension.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">le_sec_pending_q</span></code></p>
<p>Queue for LE CoC(Connection Oriented Channel) channels waiting for security check completion.</p>
<p>refer to <a class="reference external" href="https://blog.csdn.net/Wendell_Gong/article/details/54956499">https://blog.csdn.net/Wendell_Gong/article/details/54956499</a>.</p>
</li>
</ul>
</div>
<div class="section" id="tl2c-ccb">
<h2>tL2C_CCB<a class="headerlink" href="#tl2c-ccb" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span> <span class="cm">/* Define a channel control block (CCB). There may be many channel control</span>
<span class="cm"> * blocks between the same two Bluetooth devices (i.e. on the same link).</span>
<span class="cm"> * Each CCB has unique local and remote CIDs. All channel control blocks on</span>
<span class="cm"> * the same physical link and are chained together.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">t_l2c_ccb</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">in_use</span><span class="p">;</span>                <span class="cm">/* true when in use, false when not */</span>
  <span class="n">tL2C_CHNL_STATE</span> <span class="n">chnl_state</span><span class="p">;</span> <span class="cm">/* Channel state */</span>
  <span class="n">tL2CAP_LE_CFG_INFO</span>
      <span class="n">local_conn_cfg</span><span class="p">;</span> <span class="cm">/* Our config for ble conn oriented channel */</span>
  <span class="n">tL2CAP_LE_CFG_INFO</span>
      <span class="n">peer_conn_cfg</span><span class="p">;</span>       <span class="cm">/* Peer device config ble conn oriented channel */</span>
  <span class="kt">bool</span> <span class="n">is_first_seg</span><span class="p">;</span>       <span class="cm">/* Dtermine whether the received packet is the first</span>
<span class="cm">                              segment or not */</span>
  <span class="n">BT_HDR</span><span class="o">*</span> <span class="n">ble_sdu</span><span class="p">;</span>         <span class="cm">/* Buffer for storing unassembled sdu*/</span>
  <span class="kt">uint16_t</span> <span class="n">ble_sdu_length</span><span class="p">;</span> <span class="cm">/* Length of unassembled sdu length*/</span>
  <span class="k">struct</span> <span class="n">t_l2c_ccb</span><span class="o">*</span> <span class="n">p_next_ccb</span><span class="p">;</span> <span class="cm">/* Next CCB in the chain */</span>
  <span class="k">struct</span> <span class="n">t_l2c_ccb</span><span class="o">*</span> <span class="n">p_prev_ccb</span><span class="p">;</span> <span class="cm">/* Previous CCB in the chain */</span>
  <span class="k">struct</span> <span class="n">t_l2c_linkcb</span><span class="o">*</span> <span class="n">p_lcb</span><span class="p">;</span>   <span class="cm">/* Link this CCB is assigned to */</span>

  <span class="kt">uint16_t</span> <span class="n">local_cid</span><span class="p">;</span>  <span class="cm">/* Local CID */</span>
  <span class="kt">uint16_t</span> <span class="n">remote_cid</span><span class="p">;</span> <span class="cm">/* Remote CID */</span>

  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">l2c_ccb_timer</span><span class="p">;</span> <span class="cm">/* CCB Timer Entry */</span>

  <span class="n">tL2C_RCB</span><span class="o">*</span> <span class="n">p_rcb</span><span class="p">;</span>      <span class="cm">/* Registration CB for this Channel */</span>
  <span class="kt">bool</span> <span class="n">should_free_rcb</span><span class="p">;</span> <span class="cm">/* True if RCB was allocated on the heap */</span>

<span class="cp">#define IB_CFG_DONE 0x01</span>
<span class="cp">#define OB_CFG_DONE 0x02</span>
<span class="cp">#define RECONFIG_FLAG 0x04 </span><span class="cm">/* True after initial configuration */</span><span class="cp"></span>
<span class="cp">#define CFG_DONE_MASK (IB_CFG_DONE | OB_CFG_DONE)</span>

  <span class="kt">uint8_t</span> <span class="n">config_done</span><span class="p">;</span> <span class="cm">/* Configuration flag word */</span>
  <span class="kt">uint8_t</span> <span class="n">local_id</span><span class="p">;</span>    <span class="cm">/* Transaction ID for local trans */</span>
  <span class="kt">uint8_t</span> <span class="n">remote_id</span><span class="p">;</span>   <span class="cm">/* Transaction ID for local */</span>

<span class="cp">#define CCB_FLAG_NO_RETRY 0x01     </span><span class="cm">/* no more retry */</span><span class="cp"></span>
<span class="cp">#define CCB_FLAG_SENT_PENDING 0x02 </span><span class="cm">/* already sent pending response */</span><span class="cp"></span>
  <span class="kt">uint8_t</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">tL2CAP_CFG_INFO</span> <span class="n">our_cfg</span><span class="p">;</span>          <span class="cm">/* Our saved configuration options */</span>
  <span class="n">tL2CAP_CH_CFG_BITS</span> <span class="n">peer_cfg_bits</span><span class="p">;</span> <span class="cm">/* Store what peer wants to configure */</span>
  <span class="n">tL2CAP_CFG_INFO</span> <span class="n">peer_cfg</span><span class="p">;</span>         <span class="cm">/* Peer&#39;s saved configuration options */</span>

  <span class="n">fixed_queue_t</span><span class="o">*</span> <span class="n">xmit_hold_q</span><span class="p">;</span> <span class="cm">/* Transmit data hold queue */</span>
  <span class="kt">bool</span> <span class="n">cong_sent</span><span class="p">;</span>             <span class="cm">/* Set when congested status sent */</span>
  <span class="kt">uint16_t</span> <span class="n">buff_quota</span><span class="p">;</span>        <span class="cm">/* Buffer quota before sending congestion */</span>

  <span class="n">tL2CAP_CHNL_PRIORITY</span> <span class="n">ccb_priority</span><span class="p">;</span>  <span class="cm">/* Channel priority */</span>
  <span class="n">tL2CAP_CHNL_DATA_RATE</span> <span class="n">tx_data_rate</span><span class="p">;</span> <span class="cm">/* Channel Tx data rate */</span>
  <span class="n">tL2CAP_CHNL_DATA_RATE</span> <span class="n">rx_data_rate</span><span class="p">;</span> <span class="cm">/* Channel Rx data rate */</span>

  <span class="cm">/* Fields used for eL2CAP */</span>
  <span class="n">tL2CAP_ERTM_INFO</span> <span class="n">ertm_info</span><span class="p">;</span>
  <span class="n">tL2C_FCRB</span> <span class="n">fcrb</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">tx_mps</span><span class="p">;</span> <span class="cm">/* TX MPS adjusted based on current controller */</span>
  <span class="kt">uint16_t</span> <span class="n">max_rx_mtu</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">fcr_cfg_tries</span><span class="p">;</span>          <span class="cm">/* Max number of negotiation attempts */</span>
  <span class="kt">bool</span> <span class="n">peer_cfg_already_rejected</span><span class="p">;</span> <span class="cm">/* If mode rejected once, set to true */</span>
  <span class="kt">bool</span> <span class="n">out_cfg_fcr_present</span><span class="p">;</span> <span class="cm">/* true if cfg response shoulkd include fcr options</span>
<span class="cm">                               */</span>

<span class="cp">#define L2CAP_CFG_FCS_OUR 0x01  </span><span class="cm">/* Our desired config FCS option */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CFG_FCS_PEER 0x02 </span><span class="cm">/* Peer&#39;s desired config FCS option */</span><span class="cp"></span>
<span class="cp">#define L2CAP_BYPASS_FCS (L2CAP_CFG_FCS_OUR | L2CAP_CFG_FCS_PEER)</span>
  <span class="kt">uint8_t</span> <span class="n">bypass_fcs</span><span class="p">;</span>

<span class="cp">#if (L2CAP_NON_FLUSHABLE_PB_INCLUDED == TRUE)</span>
  <span class="kt">bool</span> <span class="n">is_flushable</span><span class="p">;</span> <span class="cm">/* true if channel is flushable */</span>
<span class="cp">#endif</span>

<span class="cp">#if (L2CAP_NUM_FIXED_CHNLS &gt; 0 || L2CAP_UCD_INCLUDED == TRUE)</span>
  <span class="kt">uint16_t</span> <span class="n">fixed_chnl_idle_tout</span><span class="p">;</span> <span class="cm">/* Idle timeout to use for the fixed channel */</span>
<span class="cp">#endif</span>
  <span class="kt">uint16_t</span> <span class="n">tx_data_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tL2C_CCB</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">in_use</span></code></p>
<p>test if the channel was used or  not currently.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">chnl_state</span></code></p>
<p>Chhannel State:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define the possible L2CAP channel states. The names of</span>
<span class="cm"> * the states may seem a bit strange, but they are taken from</span>
<span class="cm"> * the Bluetooth specification.</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">CST_CLOSED</span><span class="p">,</span>                  <span class="cm">/* Channel is in closed state */</span>
  <span class="n">CST_ORIG_W4_SEC_COMP</span><span class="p">,</span>        <span class="cm">/* Originator waits security clearence */</span>
  <span class="n">CST_TERM_W4_SEC_COMP</span><span class="p">,</span>        <span class="cm">/* Acceptor waits security clearence */</span>
  <span class="n">CST_W4_L2CAP_CONNECT_RSP</span><span class="p">,</span>    <span class="cm">/* Waiting for peer conenct response */</span>
  <span class="n">CST_W4_L2CA_CONNECT_RSP</span><span class="p">,</span>     <span class="cm">/* Waiting for upper layer connect rsp */</span>
  <span class="n">CST_CONFIG</span><span class="p">,</span>                  <span class="cm">/* Negotiating configuration */</span>
  <span class="n">CST_OPEN</span><span class="p">,</span>                    <span class="cm">/* Data transfer state */</span>
  <span class="n">CST_W4_L2CAP_DISCONNECT_RSP</span><span class="p">,</span> <span class="cm">/* Waiting for peer disconnect rsp */</span>
  <span class="n">CST_W4_L2CA_DISCONNECT_RSP</span>   <span class="cm">/* Waiting for upper layer disc rsp */</span>
<span class="p">}</span> <span class="n">tL2C_CHNL_STATE</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">local_conn_cfg</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_conn_cfg</span></code></p>
<p>our and peer configuration for BLE Oriented Channel</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define a structure to hold the configuration parameter for LE L2CAP</span>
<span class="cm"> * connection oriented channels.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">mtu</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">mps</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tL2CAP_LE_CFG_INFO</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_first_seg</span></code></p>
<p>Dtermine whether the received packet is the first segment or not.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_sdu</span></code></p>
<p>Buffer for storing unassembled sdu</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ble_sdu_length</span></code></p>
<p>Length of unassembled sdu length</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_next_ccb</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_prev_ccb</span></code></p>
<p>main the chain of the CCB.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span> <span class="cm">/* For all channels, send the event through their FSMs */</span>
<span class="k">for</span> <span class="p">(</span><span class="n">p_ccb</span> <span class="o">=</span> <span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">ccb_queue</span><span class="p">.</span><span class="n">p_first_ccb</span><span class="p">;</span> <span class="n">p_ccb</span><span class="p">;</span>
     <span class="n">p_ccb</span> <span class="o">=</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_next_ccb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">chnl_state</span> <span class="o">==</span> <span class="n">CST_CLOSED</span><span class="p">)</span>
    <span class="n">l2c_csm_execute</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">L2CEVT_LP_CONNECT_CFM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_lcb</span></code></p>
<p>Link this CCB is assigned to</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">local_cid</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">remote_cid</span></code></p>
<p>local and remote CID determined an App link between two devices.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">l2c_ccb_timer</span></code></p>
<p>timer for state transition on a bluetooth channel.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">l2c_ccb_timer</span> <span class="o">=</span> <span class="n">alarm_new</span><span class="p">(</span><span class="s">&quot;l2c.l2c_ccb_timer&quot;</span><span class="p">);</span>

<span class="n">alarm_set_on_mloop</span><span class="p">(</span><span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">l2c_lcb_timer</span><span class="p">,</span>
             <span class="n">L2CAP_LINK_ROLE_SWITCH_TIMEOUT_MS</span><span class="p">,</span>
             <span class="n">l2c_lcb_timer_timeout</span><span class="p">,</span> <span class="n">p_lcb</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Timeout values (in milliseconds).</span>
<span class="cm"> */</span>
<span class="cp">#define L2CAP_LINK_ROLE_SWITCH_TIMEOUT_MS (10 * 1000)  </span><span class="cm">/* 10 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_LINK_CONNECT_TIMEOUT_MS (20 * 1000)      </span><span class="cm">/* 20 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_LINK_CONNECT_EXT_TIMEOUT_MS (120 * 1000) </span><span class="cm">/* 120 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_ECHO_RSP_TIMEOUT_MS (30 * 1000)          </span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_LINK_FLOW_CONTROL_TIMEOUT_MS (2 * 1000)  </span><span class="cm">/* 2 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_LINK_DISCONNECT_TIMEOUT_MS (30 * 1000)   </span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CHNL_CONNECT_TIMEOUT_MS (20 * 1000)      </span><span class="cm">/* 20 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CHNL_CONNECT_EXT_TIMEOUT_MS (120 * 1000) </span><span class="cm">/* 120 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CHNL_CFG_TIMEOUT_MS (30 * 1000)          </span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CHNL_DISCONNECT_TIMEOUT_MS (10 * 1000)   </span><span class="cm">/* 10 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_DELAY_CHECK_SM4_TIMEOUT_MS (2 * 1000)    </span><span class="cm">/* 2 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_WAIT_INFO_RSP_TIMEOUT_MS (3 * 1000)      </span><span class="cm">/* 3 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_BLE_LINK_CONNECT_TIMEOUT_MS (30 * 1000)  </span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_FCR_ACK_TIMEOUT_MS 200                   </span><span class="cm">/* 200 milliseconds */</span><span class="cp"></span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">p_rcb</span></code></p>
<p>Registration CB for this Channel.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">should_free_rcb</span></code></p>
<p>True if RCB was allocated on the heap.</p>
<p>set to false in <cite>l2cu_allocate_ccb</cite>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">config_done</span></code></p>
<p>Configuration flag word. used during l2cap  configuration  exchannge.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define IB_CFG_DONE 0x01</span>
<span class="cp">#define OB_CFG_DONE 0x02</span>
<span class="cp">#define RECONFIG_FLAG 0x04 </span><span class="cm">/* True after initial configuration */</span><span class="cp"></span>
<span class="cp">#define CFG_DONE_MASK (IB_CFG_DONE | OB_CFG_DONE)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">local_id</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">remote_id</span></code></p>
<p>Transaction ID for identify connection request/response pair.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">flags</span></code></p>
<p>use for tracking specific state during connection.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CCB_FLAG_NO_RETRY 0x01     </span><span class="cm">/* no more retry */</span><span class="cp"></span>
<span class="cp">#define CCB_FLAG_SENT_PENDING 0x02 </span><span class="cm">/* already sent pending response */</span><span class="cp"></span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">our_cfg</span></code></p>
<p>Our saved configuration options</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_cfg_bits</span></code></p>
<p>Store what peer wants to configure</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* L2CAP channel configured field bitmap */</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_MTU 0x0001</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_QOS 0x0002</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_FLUSH_TO 0x0004</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_FCR 0x0008</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_FCS 0x0010</span>
<span class="cp">#define L2CAP_CH_CFG_MASK_EXT_FLOW_SPEC 0x0020</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_cfg</span></code></p>
<p>Peer’s saved configuration options.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">xmit_hold_q</span></code></p>
<p>pennding packets for transmitting.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">cong_sent</span></code></p>
<p>Set when congested status sent</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">buff_quota</span></code></p>
<p>Buffer quota before sending congestion.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ccb_priority</span></code></p>
<p>channel priority <cite>l2cu_change_pri_ccb</cite>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Values for priority parameter to L2CA_SetTxPriority */</span>
<span class="cp">#define L2CAP_CHNL_PRIORITY_HIGH 0</span>
<span class="cp">#define L2CAP_CHNL_PRIORITY_MEDIUM 1</span>
<span class="cp">#define L2CAP_CHNL_PRIORITY_LOW 2</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tx_data_rate</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">rx_data_rate</span></code></p>
<p>Channel Tx/RX data rate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Values for Tx/Rx data rate parameter to L2CA_SetChnlDataRate */</span>
<span class="cp">#define L2CAP_CHNL_DATA_RATE_HIGH 3</span>
<span class="cp">#define L2CAP_CHNL_DATA_RATE_MEDIUM 2</span>
<span class="cp">#define L2CAP_CHNL_DATA_RATE_LOW 1</span>
<span class="cp">#define L2CAP_CHNL_DATA_RATE_NO_TRAFFIC 0</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ertm_info</span></code></p>
<p>Fields used for eL2CAP.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define the structure that applications use to create or accept</span>
<span class="cm"> * connections with enhanced retransmission mode.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">preferred_mode</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">allowed_modes</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">user_rx_buf_size</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">user_tx_buf_size</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">fcr_rx_buf_size</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">fcr_tx_buf_size</span><span class="p">;</span>

<span class="p">}</span> <span class="n">tL2CAP_ERTM_INFO</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">fcrb</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">next_tx_seq</span><span class="p">;</span>       <span class="cm">/* Next sequence number to be Tx&#39;ed */</span>
  <span class="kt">uint8_t</span> <span class="n">last_rx_ack</span><span class="p">;</span>       <span class="cm">/* Last sequence number ack&#39;ed by the peer */</span>
  <span class="kt">uint8_t</span> <span class="n">next_seq_expected</span><span class="p">;</span> <span class="cm">/* Next peer sequence number expected */</span>
  <span class="kt">uint8_t</span> <span class="n">last_ack_sent</span><span class="p">;</span>     <span class="cm">/* Last peer sequence number ack&#39;ed */</span>
  <span class="kt">uint8_t</span> <span class="n">num_tries</span><span class="p">;</span>         <span class="cm">/* Number of retries to send a packet */</span>
  <span class="kt">uint8_t</span> <span class="n">max_held_acks</span><span class="p">;</span>     <span class="cm">/* Max acks we can hold before sending */</span>

  <span class="kt">bool</span> <span class="n">remote_busy</span><span class="p">;</span> <span class="cm">/* true if peer has flowed us off */</span>
  <span class="kt">bool</span> <span class="n">local_busy</span><span class="p">;</span>  <span class="cm">/* true if we have flowed off the peer */</span>

  <span class="kt">bool</span> <span class="n">rej_sent</span><span class="p">;</span>       <span class="cm">/* Reject was sent */</span>
  <span class="kt">bool</span> <span class="n">srej_sent</span><span class="p">;</span>      <span class="cm">/* Selective Reject was sent */</span>
  <span class="kt">bool</span> <span class="n">wait_ack</span><span class="p">;</span>       <span class="cm">/* Transmitter is waiting ack (poll sent) */</span>
  <span class="kt">bool</span> <span class="n">rej_after_srej</span><span class="p">;</span> <span class="cm">/* Send a REJ when SREJ clears */</span>

  <span class="kt">bool</span> <span class="n">send_f_rsp</span><span class="p">;</span> <span class="cm">/* We need to send an F-bit response */</span>

  <span class="kt">uint16_t</span> <span class="n">rx_sdu_len</span><span class="p">;</span> <span class="cm">/* Length of the SDU being received */</span>
  <span class="n">BT_HDR</span><span class="o">*</span> <span class="n">p_rx_sdu</span><span class="p">;</span>    <span class="cm">/* Buffer holding the SDU being received */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span>
      <span class="n">waiting_for_ack_q</span><span class="p">;</span>          <span class="cm">/* Buffers sent and waiting for peer to ack */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span> <span class="n">srej_rcv_hold_q</span><span class="p">;</span> <span class="cm">/* Buffers rcvd but held pending SREJ rsp */</span>
  <span class="n">fixed_queue_t</span><span class="o">*</span> <span class="n">retrans_q</span><span class="p">;</span>       <span class="cm">/* Buffers being retransmitted */</span>

  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">ack_timer</span><span class="p">;</span>         <span class="cm">/* Timer delaying RR */</span>
  <span class="n">alarm_t</span><span class="o">*</span> <span class="n">mon_retrans_timer</span><span class="p">;</span> <span class="cm">/* Timer Monitor or Retransmission */</span>

<span class="cp">#if (L2CAP_ERTM_STATS == TRUE)</span>
  <span class="kt">uint32_t</span> <span class="n">connect_tick_count</span><span class="p">;</span>  <span class="cm">/* Time channel was established */</span>
  <span class="kt">uint32_t</span> <span class="n">ertm_pkt_counts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>  <span class="cm">/* Packets sent and received */</span>
  <span class="kt">uint32_t</span> <span class="n">ertm_byte_counts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* Bytes   sent and received */</span>
  <span class="kt">uint32_t</span> <span class="n">s_frames_sent</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>    <span class="cm">/* S-frames sent (RR, REJ, RNR, SREJ) */</span>
  <span class="kt">uint32_t</span> <span class="n">s_frames_rcvd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>    <span class="cm">/* S-frames rcvd (RR, REJ, RNR, SREJ) */</span>
  <span class="kt">uint32_t</span> <span class="n">xmit_window_closed</span><span class="p">;</span>  <span class="cm">/* # of times the xmit window was closed */</span>
  <span class="kt">uint32_t</span> <span class="n">controller_idle</span><span class="p">;</span> <span class="cm">/* # of times less than 2 packets in controller */</span>
                            <span class="cm">/* when the xmit window was closed */</span>
  <span class="kt">uint32_t</span> <span class="n">pkts_retransmitted</span><span class="p">;</span> <span class="cm">/* # of packets that were retransmitted */</span>
  <span class="kt">uint32_t</span> <span class="n">retrans_touts</span><span class="p">;</span>      <span class="cm">/* # of retransmission timouts */</span>
  <span class="kt">uint32_t</span> <span class="n">xmit_ack_touts</span><span class="p">;</span>     <span class="cm">/* # of xmit ack timouts */</span>

<span class="cp">#define L2CAP_ERTM_STATS_NUM_AVG 10</span>
<span class="cp">#define L2CAP_ERTM_STATS_AVG_NUM_SAMPLES 100</span>
  <span class="kt">uint32_t</span> <span class="n">ack_delay_avg_count</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">ack_delay_avg_index</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">throughput_start</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">throughput</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_delay_avg</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_delay_min</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_delay_max</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_q_count_avg</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_q_count_min</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">ack_q_count_max</span><span class="p">[</span><span class="n">L2CAP_ERTM_STATS_NUM_AVG</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">tL2C_FCRB</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tx_mps</span></code></p>
<p>TX MPS(Max Payload Size) adjusted based on current controller.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">max_rx_mtu</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">fcr_cfg_tries</span></code></p>
<p>Max number of negotiation attempts.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">peer_cfg_already_rejected</span></code></p>
<p>If mode rejected once, set to true.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">out_cfg_fcr_present</span></code></p>
<p>true if cfg response should include fcr options.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">bypass_fcs</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define L2CAP_CFG_FCS_OUR 0x01  </span><span class="cm">/* Our desired config FCS option */</span><span class="cp"></span>
<span class="cp">#define L2CAP_CFG_FCS_PEER 0x02 </span><span class="cm">/* Peer&#39;s desired config FCS option */</span><span class="cp"></span>
<span class="cp">#define L2CAP_BYPASS_FCS (L2CAP_CFG_FCS_OUR | L2CAP_CFG_FCS_PEER)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">is_flushable</span></code></p>
<p>true if channel is flushable.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">fixed_chnl_idle_tout</span></code></p>
<p>Idle timeout to use for the fixed channel.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tx_data_len</span></code></p>
<p>TX data length.</p>
</li>
</ul>
</div>
<div class="section" id="tl2c-rcb">
<h2>tl2c_RCB<a class="headerlink" href="#tl2c-rcb" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>define a registration control block. Every application (e.g. RFCOMM, SDP,</dt>
<dd>TCS etc) that registers with L2CAP is assigned one of these.</dd>
</dl>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">in_use</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">psm</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">real_psm</span><span class="p">;</span> <span class="cm">/* This may be a dummy RCB for an o/b connection but */</span>
                       <span class="cm">/* this is the real PSM that we need to connect to */</span>
  <span class="cp">#if (L2CAP_UCD_INCLUDED == TRUE)</span>
    <span class="n">tL2C_UCD_REG</span> <span class="n">ucd</span><span class="p">;</span>
  <span class="cp">#endif</span>

    <span class="n">tL2CAP_APPL_INFO</span> <span class="n">api</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">tL2C_RCB</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">in_use</span></code></p>
<p>allocated to the app or  not.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">psm</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">real_psm</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ucd</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define L2C_UCD_RCB_ID 0x00</span>
<span class="cp">#define L2C_UCD_STATE_UNUSED 0x00</span>
<span class="cp">#define L2C_UCD_STATE_W4_DATA 0x01</span>
<span class="cp">#define L2C_UCD_STATE_W4_RECEPTION 0x02</span>
<span class="cp">#define L2C_UCD_STATE_W4_MTU 0x04</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">state</span><span class="p">;</span>
  <span class="n">tL2CAP_UCD_CB_INFO</span> <span class="n">cb_info</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tL2C_UCD_REG</span><span class="p">;</span>

<span class="p">...</span>

<span class="cm">/* UCD registration info (the callback addresses and PSM)</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">tL2CA_UCD_DISCOVER_CB</span><span class="o">*</span> <span class="n">pL2CA_UCD_Discover_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_UCD_DATA_CB</span><span class="o">*</span> <span class="n">pL2CA_UCD_Data_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_UCD_CONGESTION_STATUS_CB</span><span class="o">*</span> <span class="n">pL2CA_UCD_Congestion_Status_Cb</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tL2CAP_UCD_CB_INFO</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">api</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Define the structure that applications use to register with</span>
<span class="cm"> * L2CAP. This structure includes callback functions. All functions</span>
<span class="cm"> * MUST be provided, with the exception of the &quot;connect pending&quot;</span>
<span class="cm"> * callback and &quot;congestion status&quot; callback.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">tL2CA_CONNECT_IND_CB</span><span class="o">*</span> <span class="n">pL2CA_ConnectInd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_CONNECT_CFM_CB</span><span class="o">*</span> <span class="n">pL2CA_ConnectCfm_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_CONNECT_PND_CB</span><span class="o">*</span> <span class="n">pL2CA_ConnectPnd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_CONFIG_IND_CB</span><span class="o">*</span> <span class="n">pL2CA_ConfigInd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_CONFIG_CFM_CB</span><span class="o">*</span> <span class="n">pL2CA_ConfigCfm_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_DISCONNECT_IND_CB</span><span class="o">*</span> <span class="n">pL2CA_DisconnectInd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_DISCONNECT_CFM_CB</span><span class="o">*</span> <span class="n">pL2CA_DisconnectCfm_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_QOS_VIOLATION_IND_CB</span><span class="o">*</span> <span class="n">pL2CA_QoSViolationInd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_DATA_IND_CB</span><span class="o">*</span> <span class="n">pL2CA_DataInd_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_CONGESTION_STATUS_CB</span><span class="o">*</span> <span class="n">pL2CA_CongestionStatus_Cb</span><span class="p">;</span>
  <span class="n">tL2CA_TX_COMPLETE_CB</span><span class="o">*</span> <span class="n">pL2CA_TxComplete_Cb</span><span class="p">;</span>

<span class="p">}</span> <span class="n">tL2CAP_APPL_INFO</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="L2CAP API for Higher Layers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Code Architecture Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Jackson Fu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>